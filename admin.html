<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechCore</title>
    <link rel="icon" href="data:,"> 

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* === RESET & BASIC === */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f4f7fc; color: #2d3436; }
        
        /* === HEADER STİLİ === */
        .panel-header {
            position: sticky; top: 0; z-index: 1000; background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; height: 70px;
        }

        .logo {
            display: flex !important; flex-direction: row !important; align-items: center !important;
            justify-content: flex-start !important; gap: 15px !important; cursor: pointer;
            height: 100%; text-decoration: none; min-width: 200px;
        }

        .logo-text {
            display: flex !important; flex-direction: column !important; justify-content: center !important;
            align-items: flex-start !important; text-align: left !important; line-height: 1.3;
        }

        .logo-text span:first-child { font-weight: bold; font-size: 16px; color: #2d3436; white-space: nowrap; }
        .logo-text span:last-child { font-size: 13px; color: #636e72; white-space: nowrap; }

        .logo-icon {
            width: 42px; height: 42px; min-width: 42px; border-radius: 50%;
            background-color: #0984e3; color: #fff; display: flex; align-items: center;
            justify-content: center; font-weight: bold; font-size: 18px;
            background-size: cover; background-position: center;
        }

        .header-actions { display: flex; align-items: center; gap: 15px; }

        /* DİL DÜYMƏSİ */
        .lang-switcher { position: relative; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500; color: #636e72; }
        .lang-dropdown {
            display: none; position: absolute; top: 100%; right: 0; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; z-index: 1001; margin-top: 10px;
        }
        .lang-dropdown.show { display: block; }
        .lang-dropdown a { display: block; padding: 10px 20px; text-decoration: none; color: #2d3436; font-size: 14px; transition: background 0.2s; white-space: nowrap; }
        .lang-dropdown a:hover { background: #f1f2f6; }

        .logout-btn {
            background: #ff7675; color: white; border: none; padding: 8px 15px; border-radius: 6px;
            cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .logout-btn:hover { background: #d63031; }

        /* === MAIN PANEL === */
        .panel-main { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .panel-title { margin-bottom: 25px; }
        .panel-title h2 { margin: 0; font-size: 24px; color: #2d3436; }
        .panel-title span { font-size: 14px; color: #b2bec3; }

        /* STAT KARTLARI */
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card.green { border-left: 5px solid #00b894; }
        .card.green-light { border-left: 5px solid #55efc4; }
        .card.orange { border-left: 5px solid #fdcb6e; }
        .card.purple { border-left: 5px solid #a29bfe; }
        .card-info { display: flex; flex-direction: column; }
        .card-title { font-size: 12px; color: #636e72; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .card-value { font-size: 24px; font-weight: bold; color: #2d3436; }
        .card-icon { font-size: 28px; opacity: 0.2; }

        /* TABS */
        .content-tabs { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; min-height: 500px; }
        .tab-nav { display: flex; align-items: center; gap: 10px; background: #f1f2f6; padding: 10px 20px; border-bottom: 1px solid #dfe6e9; }
        .tab-link {
            padding: 10px 15px; background: transparent; border: none; cursor: pointer;
            font-weight: 500; color: #636e72; border-radius: 6px; transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .tab-link:hover { background: rgba(0,0,0,0.05); color: #2d3436; }
        .tab-link.active { background: white; color: #0984e3; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .tab-link[data-tab="add-equip-tab"] { margin-left: auto; background-color: #00b894; color: white !important; }
        .tab-link[data-tab="add-equip-tab"]:hover { background-color: #00a884; }
        .tab-link[data-tab="add-equip-tab"].active { background-color: #008f72; }
        .tab-link[data-tab="add-equip-tab"] i { color: white !important; }

        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* LIST HEADER & SEARCH */
        .list-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; flex-wrap: wrap; gap: 10px; }
        .search-bar {
            background: #f1f2f6; border-radius: 8px; padding: 8px 15px; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 400px; border: 1px solid transparent;
        }
        .search-bar:focus-within { background: white; border-color: #0984e3; }
        .search-bar input { border: none; background: transparent; width: 100%; outline: none; font-size: 14px; }
        .search-bar i { color: #b2bec3; }

        .add-user-btn { background: #0984e3; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .add-user-btn:hover { background: #0769b5; }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 40px; color: #b2bec3; }
        .empty-state i { font-size: 48px; margin-bottom: 15px; display: block; }
        .empty-state h3 { font-size: 18px; font-weight: normal; margin: 0; }

        /* FORM ELEMENTS */
        .form-container { max-width: 800px; margin: 0 auto; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        .form-group.full-width { width: 100%; }
        .form-group label { margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #636e72; }
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 14px;
            background: #fcfcfc; font-family: inherit; width: 100%;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #0984e3; outline: none; background: white;
        }

        .holder-info-group { background: #f1faff; padding: 20px; border-radius: 10px; border: 1px solid #bce0fd; margin-bottom: 25px; }
        .holder-info-title { font-size: 15px; color: #0984e3; margin-bottom: 15px; font-weight: bold; display: flex; align-items: center; gap: 8px; }

        /* BUTTONS */
        .submit-btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 500; display: flex; align-items: center; gap: 8px; justify-content: center; font-size: 14px;
        }
        .btn-primary { background: #0984e3; color: white; }
        .btn-primary:hover { background: #0769b5; }
        .btn-secondary { background: #dfe6e9; color: #2d3436; }
        .btn-secondary:hover { background: #b2bec3; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-success { background: #27ae60; color: white; }
        .btn-view-image { width: 100%; padding: 10px; background-color: #6c5ce7; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; }

        /* CARDS & LISTS */
        .equipment-card-list, .holder-card-list, .user-card-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px 0;
        }
        
        /* Equipment Card */
        .equipment-card {
            background: #fff; border-radius: 10px; border: 1px solid #eee; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, box-shadow 0.2s;
        }
        .equipment-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-header h3 { margin: 0 0 5px 0; font-size: 16px; color: #2d3436; }
        .card-subtitle { margin: 0; font-size: 13px; color: #636e72; }
        .card-tags { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-işlək, .status-working, .status-active { background: #e6fffa; color: #00b894; border: 1px solid #00b894; }
        .status-xarab, .status-broken, .status-deactivated { background: #fff5f5; color: #d63031; border: 1px solid #d63031; }
        .status-təmirdə, .status-repair { background: #fff4e6; color: #e67e22; border: 1px solid #e67e22; }
        
        .card-body { margin: 15px 0; font-size: 13px; color: #636e72; }
        .card-body div { margin-bottom: 4px; display: flex; justify-content: space-between; }
        .card-body span { font-weight: 500; color: #2d3436; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #f1f2f6; }
        .card-footer span { font-size: 11px; color: #b2bec3; }
        
        .action-btn { background: none; border: none; cursor: pointer; font-size: 15px; margin-left: 5px; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.2); }
        .btn-view { color: #0984e3; }
        .btn-edit { color: #f39c12; }
        .btn-return { color: #27ae60; }
        .btn-qr { color: #2d3436; }

        /* Holder Card */
        .holder-card {
            background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px; border: 1px solid #eee; display: flex; flex-direction: column; justify-content: space-between;
        }
        .holder-header { display: flex; align-items: center; margin-bottom: 15px; }
        .holder-icon {
            width: 50px; height: 50px; background-color: #e3f2fd; color: #0984e3;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px;
        }
        .holder-card[data-name="Anbar"] .holder-icon { background-color: #ffeaa7; color: #d35400; }
        .holder-details h3 { margin: 0; font-size: 16px; color: #2d3436; }
        .holder-details p { margin: 3px 0 0; font-size: 13px; color: #636e72; }
        .holder-stats {
            display: flex; justify-content: space-between; align-items: center;
            background: #f9f9f9; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;
        }
        .holder-count { font-weight: bold; color: #2d3436; }
        .holder-actions button {
            width: 100%; padding: 10px; border: none; background-color: #0984e3; color: white;
            border-radius: 6px; cursor: pointer; font-weight: 500;
        }

        /* User Card */
        .user-card {
            background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #f1f2f6; display: none; flex-direction: column;
        }
        .user-card.visible { display: flex; }
        .user-card.deactivated { background-color: #fff5f5; border: 1px solid #ffcccc; opacity: 0.8; }
        .user-card.deactivated .user-name { text-decoration: line-through; color: #c0392b; }
        .user-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: #2d3436; color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; background-size: cover; }
        .user-avatar.admin { background: #0984e3; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: bold; font-size: 15px; color: #2d3436; }
        .user-email { font-size: 12px; color: #636e72; }
        .role-badge { padding: 3px 6px; border-radius: 5px; font-size: 10px; font-weight: bold; text-transform: uppercase; background: #e3f2fd; color: #0984e3; border: 1px solid #0984e3; }
        .role-badge.warehouse { background: #e6fffa; color: #00b894; border: 1px solid #00b894; }
        .user-actions { display: flex; gap: 8px; margin-top: auto; padding-top: 12px; border-top: 1px solid #f1f2f6; }
        .user-action-btn {
            flex: 1; padding: 6px; border: 1px solid #dfe6e9; background: white; border-radius: 6px;
            font-size: 11px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .user-action-btn:hover { background: #f1f2f6; }

        /* MODALS */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
        }
        .view-equipment-modal { max-width: 900px !important; width: 95% !important; }
        .modal-header { margin-bottom: 20px; padding-right: 30px; }
        .modal-header h2 { font-size: 20px; color: #2d3436; margin: 0; }
        .modal-close-btn {
            background: none; border: none; font-size: 22px; color: #636e72; cursor: pointer;
            position: absolute; top: 20px; right: 20px; transition: color 0.2s;
        }
        .modal-close-btn:hover { color: #d63031; }
        .modal-body { display: flex; flex-direction: column; gap: 15px; }
        .modal-footer { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Specific Modal Styles */
        .profile-pic-wrapper { display: flex; justify-content: center; margin-bottom: 25px; }
        .profile-pic {
            width: 100px; height: 100px; border-radius: 50%; background: #0984e3; color: white;
            font-size: 36px; font-weight: bold; display: flex; justify-content: center; align-items: center;
            position: relative; border: 4px solid #f1f2f6; background-size: cover;
        }
        .upload-btn {
            position: absolute; bottom: 0; right: 0; background: #2d3436; color: white; width: 32px; height: 32px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 14px; border: 2px solid white;
        }
        .change-password-btn { width: 100%; margin-top: 10px; background: transparent; border: 1px dashed #b2bec3; color: #636e72; }
        
        /* Tables in Modals */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; font-size: 12px; color: #636e72; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; font-size: 14px; }
        
        /* QR Code */
        .qr-code-section { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; padding: 20px; border-radius: 12px; border: 2px dashed #0984e3; }
        
        /* Details Grid */
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .detail-item { background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #f1f2f6; }
        .detail-label { font-size: 11px; text-transform: uppercase; color: #a4b0be; font-weight: bold; display: block; }
        .detail-value { font-size: 14px; color: #2d3436; font-weight: 500; word-break: break-all; }
        .full-width { grid-column: 1 / -1; }

    </style>
</head>
<body>
    <div class="page-container">
        <header class="panel-header">
            <div class="logo" id="profile-btn">
                <div class="logo-icon admin" id="profile-pic-header">AD</div>
                <div class="logo-text">
                    <span data-key="adminWelcome">Admin İstifadəçi</span>
                    <span id="admin-name-display" data-key="loading">Yüklənir...</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="lang-switcher" id="lang-btn">
                    <i class="fas fa-globe"></i>
                    <span class="lang-btn-text">AZ</span>
                    <div class="lang-dropdown" id="lang-dropdown">
                        <a href="#" data-lang="az" data-key="langAzerbaijani">Azərbaycanca (AZ)</a>
                        <a href="#" data-lang="en" data-key="langEnglish">English (EN)</a>
                        <a href="#" data-lang="ru" data-key="langRussian">Русский (RU)</a>
                    </div>
                </div>
                <button id="logout-btn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> <span data-key="logout">Çıxış</span>
                </button>
            </div>
        </header>

        <main class="panel-main">
            <div class="panel-title">
                <h2 data-key="adminPanelTitle">Admin Paneli</h2>
                <span data-key="appName">TechCore Inventory</span>
            </div>

            <section class="stat-cards">
                <div class="card green">
                    <div class="card-info">
                        <span class="card-title" data-key="statTotalEquipment">Ümumi Avadanlıq</span>
                        <span class="card-value" id="stat-total">0</span>
                    </div>
                    <div class="card-icon"><i class="fas fa-box"></i></div>
                </div>
                <div class="card green-light">
                    <div class="card-info">
                        <span class="card-title" data-key="statWorking">İşlək Avadanlıq</span>
                        <span class="card-value" id="stat-islek">0</span>
                    </div>
                    <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="card orange"> 
                    <div class="card-info">
                        <span class="card-title" data-key="statHolders">İstifadəçilər (Sahiblər)</span>
                        <span class="card-value" id="stat-holders">0</span>
                    </div>
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                </div>
                <div class="card purple"> 
                    <div class="card-info">
                        <span class="card-title" data-key="statWarehouse">Anbarda Olanlar</span>
                        <span class="card-value" id="stat-anbar">0</span>
                    </div>
                    <div class="card-icon"><i class="fas fa-warehouse"></i></div>
                </div>
            </section>

            <section class="content-tabs">
                <div class="tab-nav">
                    <button class="tab-link active" data-tab="inventory-tab"><i class="fas fa-tasks"></i> <span data-key="adminTabAllInventory">İnventar Siyahısı</span></button>
                    <button class="tab-link" data-tab="holders-tab"><i class="fas fa-user-tag"></i> <span data-key="tabHolders">İstifadəçilər (Sahiblər)</span></button>
                    <button class="tab-link" data-tab="users-tab"><i class="fas fa-users-cog"></i> <span data-key="adminTabUsers">Sistem Personalı</span></button>
                    <button class="tab-link" data-tab="add-equip-tab"><i class="fas fa-plus"></i> <span data-key="tabAddEquipment">Avadanlıq Əlavə Et</span></button> 
                </div>

                <div class="tab-content active" id="inventory-tab">
                    <div class="list-header">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="inventory-search" data-key="searchPlaceholder" placeholder="İşçi adı, Fakültə, avadanlıq adı və s...">
                        </div>
                    </div>
                    <div class="equipment-card-list" id="all-equipment-list"></div>
                    <div id="all-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-laptop-medical"></i>
                        <h3 data-key="emptyStateAllEquipment">Sistemdə avadanlıq yoxdur.</h3>
                    </div>
                </div>

                <div class="tab-content" id="holders-tab">
                    <div class="list-header">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="holders-search" data-key="searchHoldersPlaceholder" placeholder="İstifadəçi adı və ya fakültə axtar...">
                        </div>
                    </div>
                    <div class="holder-card-list" id="all-holders-list"></div>
                     <div id="holders-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-users-slash"></i>
                        <h3>Heç bir istifadəçi tapılmadı.</h3>
                    </div>
                </div>
                
                <div class="tab-content" id="users-tab">
                      <div class="list-header">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="user-search" data-key="searchUsersPlaceholder" placeholder="Ad, e-poçt və ya rola görə axtar...">
                        </div>
                        <button class="add-user-btn" id="add-user-btn"><i class="fas fa-plus"></i> <span data-key="addUser">Yeni Personal Yarat</span></button>
                    </div>
                    <div class="user-card-list" id="all-users-list"></div>
                </div>

                <div class="tab-content" id="add-equip-tab">
                    <section class="form-container" style="box-shadow: none;">
                        <form id="admin-add-equipment-form" class="equipment-form" style="padding-top: 15px;">
                            <div class="holder-info-group">
                                <span class="holder-info-title"><i class="fas fa-user-check"></i> <span data-key="lblHolderTitle">Avadanlıq Sahibinin Məlumatları</span></span>
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="holder-name" data-key="lblHolderName">Ad Soyad *</label>
                                        <input type="text" id="holder-name" list="holder-suggestions" autocomplete="off" required>
                                        <datalist id="holder-suggestions"></datalist>
                                    </div>
                                    <div class="form-group full-width">
                                        <label for="holder-faculty" data-key="lblHolderFaculty">Fakültə / Şöbə *</label>
                                        <select id="holder-faculty" required>
                                            <option value="" disabled selected>Seçin</option>
                                            <option value="Mühəndislik">Mühəndislik</option>
                                            <option value="Pedaqoji">Pedaqoji</option>
                                            <option value="Humanitar və Sosial Elmlər">Humanitar və Sosial Elmlər</option>
                                            <option value="İqtisadiyyat">İqtisadiyyat</option>
                                            <option value="İncəsənət">İncəsənət</option>
                                            <option value="Rəqəmsal">Rəqəmsal</option>
                                            <option value="Tibb">Tibb</option>
                                            <option value="Digər">Digər</option>
                                        </select>
                                        <input type="text" id="other-faculty-input" placeholder="Fakültə adını yazın..." style="display: none; margin-top: 5px;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="auto-id" data-key="lblSystemID">Sistem ID (Avtomatik & Dəyişməz)</label>
                                    <input type="text" id="auto-id" readonly style="background-color: #e9ecef; font-weight: bold; color: #2d3436; letter-spacing: 1px;">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="admin-equip-type" data-key="formType">Avadanlıq növü *</label>
                                    <select id="admin-equip-type" required>
                                        <option value="" disabled selected data-key="formTypeSelect">Növü seçin</option>
                                        <option value="Kompüter" data-key="formTypeComputer">Kompüter</option>
                                        <option value="Monitor" data-key="formTypeMonitor">Monitor</option>
                                        <option value="Printer" data-key="formTypePrinter">Printer</option>
                                        <option value="Digər" data-key="formTypeOther">Digər</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="admin-equip-name" data-key="formName">Avadanlığın adı *</label>
                                    <input type="text" id="admin-equip-name" data-key="formNamePlaceholder" placeholder="məs: Dell Latitude Laptop" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="admin-equip-model" data-key="formModel">Marka/Model *</label>
                                    <input type="text" id="admin-equip-model" list="brand-suggestions" data-key="formModelPlaceholder" placeholder="məs: Dell Latitude 5420" required>
                                    <datalist id="brand-suggestions">
                                        <option value="HP"><option value="Acer"><option value="Dell"><option value="Lenovo"><option value="Asus"><option value="Canon"><option value="Epson"><option value="Samsung"><option value="Apple">
                                    </datalist>
                                </div>
                                <div class="form-group">
                                    <label for="admin-equip-serial" data-key="formSerial">Serial Nömrə</label>
                                    <input type="text" id="admin-equip-serial" data-key="formSerialPlaceholder" placeholder="məs: SN123456789">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="admin-equip-mac" data-key="formMac">MAC Address</label>
                                    <input type="text" id="admin-equip-mac" data-key="formMacPlaceholder" placeholder="məs: 00:1A:2B:3C:4D:5E">
                                </div>
                                <div class="form-group">
                                    <label for="admin-equip-status" data-key="formStatus">Status *</label>
                                    <select id="admin-equip-status" required>
                                        <option value="İşlək" data-key="formStatusWorking">İşlək</option>
                                        <option value="Xarab" data-key="formStatusBroken">Xarab</option>
                                        <option value="Təmirdə" data-key="formStatusRepair">Təmirdə</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="admin-equip-date" data-key="formDate">Alınma Tarixi</label>
                                    <input type="date" id="admin-equip-date">
                                </div>
                                <div class="form-group">
                                    <label for="admin-equip-file" data-key="formUpload">Şəkil Yüklə</label>
                                    <input type="file" id="admin-equip-file" class="file-input" accept="image/*">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="admin-equip-notes" data-key="formNotes">Qeyd/Şərh</label>
                                    <textarea id="admin-equip-notes" data-key="formNotesPlaceholder" placeholder="Əlavə məlumat, xüsusi qeydlər..."></textarea>
                                </div>
                            </div>
                            <button type="submit" class="submit-btn"><i class="fas fa-save"></i> <span data-key="submitAssignEquipment">Yadda Saxla</span></button>
                        </form>
                    </section>
                </div>
            </section>
        </main>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content profile-modal">
            <button class="modal-close-btn" id="profile-modal-close"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2 data-key="profileSettings">Profil Parametrləri</h2></div>
            <form id="profile-settings-form">
                <div class="modal-body">
                    <div class="profile-pic-wrapper">
                        <div class="profile-pic" id="profile-pic-modal">AD
                            <label for="profile-pic-upload" class="upload-btn"><i class="fas fa-camera"></i></label>
                            <input type="file" id="profile-pic-upload" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group"><label for="profile-name" data-key="fullNameLabel">Tam ad</label><input type="text" id="profile-name" required></div>
                    <div class="form-group"><label for="profile-email" data-key="emailLabel">E-poçt ünvanı</label><input type="email" id="profile-email" disabled></div>
                    <button type="button" class="submit-btn btn-secondary change-password-btn" id="change-password-btn-open"><i class="fas fa-lock"></i> <span data-key="changePassword">Şifrəni Dəyiş</span></button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn btn-secondary" id="profile-cancel-btn" data-key="cancel">Ləğv et</button>
                    <button type="submit" class="submit-btn btn-primary" data-key="updateProfile">Profili Yenilə</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-user-modal" class="modal-overlay">
        <div class="modal-content profile-modal" style="width: 450px;">
            <button class="modal-close-btn" id="add-user-modal-close"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2 data-key="addUserTitle">Yeni Personal Yarat</h2></div>
            <form id="add-user-form">
                <div class="modal-body">
                    <p data-key="addUserP" style="font-size: 14px; color: #777; margin-top: 0; margin-bottom: 20px;">Sistemə giriş edə biləcək işçi (Admin/Anbardar)</p>
                    <div class="form-group"><label for="new-user-name" data-key="fullNameLabel">Tam ad</label><input type="text" id="new-user-name" required></div>
                    <div class="form-group"><label for="new-user-email" data-key="emailLabel">E-poçt ünvanı</label><input type="email" id="new-user-email" required></div>
                     <div class="form-group"><label for="new-user-password" data-key="initialPassword">İlkin Şifrə *</label><input type="password" id="new-user-password" required><small data-key="initialPasswordP" style="font-size: 12px; color: #777; margin-top: 5px;">...</small></div>
                    <div class="form-group">
                        <label for="new-user-role" data-key="thRole">Rol *</label>
                        <select id="new-user-role" required>
                            <option value="user" data-key="roleUser">Anbar İşçisi (Baxıcı)</option>
                            <option value="admin" data-key="roleAdmin">Admin (Tam İcazə)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn btn-secondary" id="add-user-cancel-btn" data-key="cancel">Ləğv et</button>
                    <button type="submit" class="submit-btn btn-primary" data-key="submitCreateUser">Yarat</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="change-password-modal" class="modal-overlay">
        <div class="modal-content profile-modal" style="width: 400px;">
            <button class="modal-close-btn" id="password-modal-close"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2 data-key="changePasswordTitle">Şifrəni Dəyiş</h2></div>
            <form id="change-password-form">
                <div class="modal-body">
                    <div class="form-group"><label for="old-password" data-key="oldPassword">Köhnə şifrə</label><input type="password" id="old-password" required></div>
                    <div class="form-group"><label for="new-password" data-key="newPassword">Yeni şifrə</label><input type="password" id="new-password" required></div>
                    <div class="form-group"><label for="confirm-new-password" data-key="confirmNewPassword">Yeni şifrəni təsdiqlə</label><input type="password" id="confirm-new-password" required></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="submit-btn btn-secondary" id="password-cancel-btn" data-key="cancel">Ləğv et</button>
                    <button type="submit" class="submit-btn btn-primary" data-key="changePassword">Şifrəni Dəyiş</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="view-equipment-modal" class="modal-overlay">
        <div class="modal-content view-equipment-modal">
            <button class="modal-close-btn" id="view-equipment-close-btn"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2 id="view-equipment-title">
                    <span id="view-equip-holder-name"></span> - <span data-key="viewEquipmentTitle">İstifadəçinin Avadanlıqları</span>
                </h2>
            </div>
            <div class="modal-body">
                <div class="list-body">
                    <table id="user-specific-equipment-table">
                        <thead>
                            <tr>
                                <th data-key="thNameModel">Adı / Model</th>
                                <th data-key="thStatus">Status</th>
                                <th data-key="thSerial">Serial Nömrə</th>
                                <th data-key="thOperations">Əməliyyat</th> </tr>
                        </thead>
                        <tbody id="user-specific-equipment-tbody"></tbody>
                    </table>
                    <div id="user-specific-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-laptop-medical"></i>
                        <h3 data-key="noEquipmentFound">Bu istifadəçi üçün avadanlıq tapılmadı.</h3>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="submit-btn btn-secondary" id="view-equipment-close-footer-btn" data-key="close">Bağla</button></div>
        </div>
    </div>

    <div id="qr-modal" class="modal-overlay">
        <div class="modal-content profile-modal" style="width: 350px;">
            <button class="modal-close-btn" onclick="document.getElementById('qr-modal').style.display='none'"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2>QR Kod</h2></div>
            <div class="modal-body" style="display: flex; flex-direction: column; align-items: center;">
                <div id="qrcode" class="qr-code-section"></div>
                <button type="button" class="submit-btn btn-success" onclick="downloadQR()" style="margin-top: 20px; width: 100%;">
                    <i class="fas fa-download"></i> QR Kodu Yüklə
                </button>
                <p id="qr-link-text" style="font-size:10px; word-break:break-all; color:grey; margin-top:5px; text-align:center;"></p>
            </div>
        </div>
    </div>

    <div id="item-details-modal" class="modal-overlay">
        <div class="modal-content profile-modal">
            <button class="modal-close-btn" id="item-details-close"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2 data-key="equipmentDetails">Avadanlıq Məlumatları</h2></div>
            <div class="modal-body">
                <div class="details-grid" id="item-details-content">
                    </div>
                <div id="item-image-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="submit-btn btn-primary" id="item-details-ok" data-key="okBtn">Oldu</button>
            </div>
        </div>
    </div>

    <div id="edit-equipment-modal" class="modal-overlay">
        <div class="modal-content profile-modal" style="width: 500px; max-width: 95%;">
            <button class="modal-close-btn" id="edit-equipment-close"><i class="fas fa-times"></i></button>
            <div class="modal-header"><h2 data-key="editEquipmentTitle">Avadanlığı Düzəlt</h2></div>
            <form id="edit-equipment-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-equip-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-key="lblHolderName">Ad Soyad</label>
                            <input type="text" id="edit-holder-name" required>
                        </div>
                        <div class="form-group">
                            <label data-key="lblHolderFaculty">Fakültə / Şöbə</label>
                            <select id="edit-holder-faculty" required>
                                <option value="" disabled selected data-key="formTypeSelect">Seçin</option>
                                <option value="Mühəndislik">Mühəndislik</option>
                                <option value="Pedaqoji">Pedaqoji</option>
                                <option value="Humanitar və Sosial Elmlər">Humanitar və Sosial Elmlər</option>
                                <option value="İqtisadiyyat">İqtisadiyyat</option>
                                <option value="İncəsənət">İncəsənət</option>
                                <option value="Rəqəmsal">Rəqəmsal</option>
                                <option value="Tibb">Tibb</option>
                                <option value="Digər">Digər</option>
                            </select>
                            <input type="text" id="edit-other-faculty-input" placeholder="Fakültə adını yazın..." style="display: none; margin-top: 5px;">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-key="formType">Avadanlıq növü</label>
                            <select id="edit-equip-type" required>
                                <option value="Kompüter" data-key="formTypeComputer">Kompüter</option>
                                <option value="Monitor" data-key="formTypeMonitor">Monitor</option>
                                <option value="Printer" data-key="formTypePrinter">Printer</option>
                                <option value="Digər" data-key="formTypeOther">Digər</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-key="formName">Avadanlığın adı</label>
                            <input type="text" id="edit-equip-name" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-key="formModel">Marka/Model</label>
                            <input type="text" id="edit-equip-model" list="brand-suggestions" required>
                        </div>
                        <div class="form-group">
                            <label data-key="formSerial">Serial Nömrə</label>
                            <input type="text" id="edit-equip-serial">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label data-key="formMac">MAC Address</label>
                            <input type="text" id="edit-equip-mac">
                        </div>
                        <div class="form-group">
                            <label data-key="formStatus">Status</label>
                            <select id="edit-equip-status">
                                <option value="İşlək" data-key="formStatusWorking">İşlək</option>
                                <option value="Xarab" data-key="formStatusBroken">Xarab</option>
                                <option value="Təmirdə" data-key="formStatusRepair">Təmirdə</option>
                            </select>
                        </div>
                    </div>
                    
                      <div class="form-group">
                        <label data-key="formNotes">Qeyd/Şərh</label>
                        <textarea id="edit-equip-notes" data-key="formNotesPlaceholder" placeholder="Xüsusi qeydləri buraya yazın..."></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <button type="button" class="submit-btn btn-warning" id="btn-return-warehouse" title="Anbara Qaytar"><i class="fas fa-box-open"></i> <span data-key="returnToWarehouse">Anbar</span></button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="submit-btn btn-secondary" id="edit-equipment-cancel" data-key="cancel">Ləğv</button>
                        <button type="submit" class="submit-btn btn-primary" data-key="submitAssignEquipment">Yadda Saxla</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <script>
        // === TƏRCÜMƏ SİSTEMİ ===
        const translations = {
            az: {
                appName: "TechCore Inventory",
                adminPanelTitle: "Admin Paneli",
                adminWelcome: "Admin İstifadəçi",
                loading: "Yüklənir...",
                langAzerbaijani: "Azərbaycanca (AZ)",
                langEnglish: "English (EN)",
                langRussian: "Русский (RU)",
                logout: "Çıxış",
                statTotalEquipment: "Ümumi Avadanlıq",
                statWorking: "İşlək Avadanlıq",
                statHolders: "İstifadəçilər (Sahiblər)",
                statWarehouse: "Anbarda Olanlar",
                adminTabAllInventory: "İnventar Siyahısı",
                tabHolders: "İstifadəçilər (Sahiblər)",
                adminTabUsers: "Sistem Personalı",
                tabAddEquipment: "Avadanlıq Əlavə Et",
                searchPlaceholder: "İşçi adı, Fakültə, avadanlıq adı və s...",
                emptyStateAllEquipment: "Sistemdə avadanlıq yoxdur.",
                lblHolderTitle: "Avadanlıq Sahibinin Məlumatları",
                lblHolderName: "Ad Soyad *",
                lblHolderFaculty: "Fakültə / Şöbə *",
                lblSystemID: "Sistem ID (Avtomatik & Dəyişməz)",
                formType: "Avadanlıq növü *",
                formTypeSelect: "Növü seçin",
                formTypeComputer: "Kompüter",
                formTypeMonitor: "Monitor",
                formTypePrinter: "Printer",
                formTypeOther: "Digər",
                formName: "Avadanlığın adı *",
                formNamePlaceholder: "məs: Dell Latitude Laptop",
                formModel: "Marka/Model *",
                formModelPlaceholder: "məs: Dell Latitude 5420",
                formSerial: "Serial Nömrə",
                formSerialPlaceholder: "məs: SN123456789",
                formMac: "MAC Address",
                formMacPlaceholder: "məs: 00:1A:2B:3C:4D:5E",
                formStatus: "Status *",
                formStatusWorking: "İşlək",
                formStatusBroken: "Xarab",
                formStatusRepair: "Təmirdə",
                formDate: "Alınma Tarixi",
                formUpload: "Şəkil Yüklə",
                formNotes: "Qeyd/Şərh",
                formNotesPlaceholder: "Əlavə məlumat, xüsusi qeydlər...",
                submitAssignEquipment: "Yadda Saxla",
                searchUsersPlaceholder: "Ad, e-poçt və ya rola görə axtar...",
                searchHoldersPlaceholder: "İstifadəçi adı və ya fakültə axtar...",
                addUser: "Yeni Personal Yarat",
                profileSettings: "Profil Parametrləri",
                fullNameLabel: "Tam ad",
                emailLabel: "E-poçt ünvanı",
                changePassword: "Şifrəni Dəyiş",
                cancel: "Ləğv et",
                updateProfile: "Profili Yenilə",
                addUserTitle: "Yeni Personal Yarat",
                addUserP: "Sistemə giriş edə biləcək işçi (Admin/Anbardar)",
                initialPassword: "İlkin Şifrə *",
                initialPasswordP: "İşçi ilk girişdə bunu dəyişə bilər.",
                thRole: "Rol *",
                roleUser: "Anbar İşçisi",
                roleAdmin: "Admin",
                submitCreateUser: "Yarat",
                changePasswordTitle: "Şifrəni Dəyiş",
                oldPassword: "Köhnə şifrə",
                newPassword: "Yeni şifrə",
                confirmNewPassword: "Yeni şifrəni təsdiqlə",
                viewEquipmentTitle: "İstifadəçinin Avadanlıqları",
                thSerial: "Serial Nömrə",
                thStatus: "Status",
                thNameModel: "Adı / Model",
                thOperations: "Əməliyyat",
                noEquipmentFound: "Bu istifadəçi üçün avadanlıq tapılmadı.",
                close: "Bağla",
                viewEquipment: "Bax",
                btnMakeUser: "Rol: İşçi Et",
                btnMakeAdmin: "Rol: Admin Et",
                btnDeactivate: "Girişi Kilidlə",
                btnActivate: "Kilidi Aç",
                statusActive: "AKTİV",
                statusDeactivated: "DEAKTİV",
                confirmChangeRole: "Bu istifadəçinin rolunu dəyişmək istədiyinizə əminsiniz?",
                confirmDeactivate: "Bu istifadəçinin sistemə girişini BLOKLAMAQ istəyirsiniz?",
                confirmActivate: "Bu istifadəçinin kilidini açmaq istəyirsiniz?",
                userLocked: "İstifadəçi deaktiv edildi.",
                userUnlocked: "İstifadəçi aktiv edildi.",
                profileUpdateSuccess: "Profil yeniləndi!",
                profileUpdateError: "Xəta: ",
                errorOnSelf: "Öz hesabınızı bloklaya bilməzsiniz!",
                equipmentAddedSuccess: "Avadanlıq uğurla əlavə edildi!",
                errorAddingEquipment: "Xəta baş verdi!",
                userCreateSuccess: "İstifadəçi yaradıldı!",
                userCreateError: "Xəta: ",
                confirmDeleteEquipment: "Bu avadanlığı silmək istədiyinizə əminsiniz?",
                viewInventory: "İnventara Bax",
                totalItems: "Say",
                equipmentDetails: "Avadanlıq Məlumatları",
                okBtn: "Oldu",
                editEquipmentTitle: "Avadanlığı Düzəlt",
                returnToWarehouse: "Anbara Qaytar",
                confirmReturn: "Bu avadanlığı Anbara qaytarmaq istəyirsiniz?",
                viewImage: "Şəkilə Bax"
            },
            en: {
                 appName: "TechCore Inventory",
                 adminPanelTitle: "TechCore Admin",
                 adminWelcome: "Admin User",
                 logout: "Logout",
                 statTotalEquipment: "Total Equipment",
                 statWorking: "Working",
                 statHolders: "Equipment Holders",
                 statWarehouse: "In Warehouse",
                 adminTabAllInventory: "Inventory List",
                 tabHolders: "Users (Holders)",
                 adminTabUsers: "System Staff",
                 tabAddEquipment: "Add Equipment",
                 lblHolderTitle: "Equipment Holder Info",
                 lblHolderName: "Holder Name *",
                 lblHolderFaculty: "Faculty/Dept *",
                 lblSystemID: "System ID (Auto)",
                 formType: "Equipment Type *",
                 formTypeSelect: "Select Type",
                 formTypeComputer: "Computer",
                 formTypeMonitor: "Monitor",
                 formTypePrinter: "Printer",
                 formTypeOther: "Other",
                 formName: "Equipment Name *",
                 formModel: "Brand/Model *",
                 formStatus: "Status *",
                 formStatusWorking: "Working",
                 formStatusBroken: "Broken",
                 formStatusRepair: "Repair",
                 formSerial: "Serial Number",
                 formMac: "MAC Address",
                 formDate: "Purchase Date",
                 formUpload: "Upload Image",
                 formNotes: "Notes/Comments",
                 formNotesPlaceholder: "Additional info, special notes...",
                 submitAssignEquipment: "Save",
                 addUser: "Create New Staff",
                 okBtn: "OK",
                 viewImage: "View Image",
                 searchPlaceholder: "Search...",
                 emptyStateAllEquipment: "No equipment found.",
                 thNameModel: "Name / Model",
                 thStatus: "Status",
                 thSerial: "Serial No",
                 thOperations: "Operations",
                 equipmentDetails: "Equipment Details",
                 searchHoldersPlaceholder: "Search user or faculty...",
                 searchUsersPlaceholder: "Search name, email or role...",
                 fullNameLabel: "Full Name",
                 emailLabel: "Email Address",
                 changePassword: "Change Password",
                 cancel: "Cancel",
                 updateProfile: "Update Profile",
                 addUserTitle: "Create New Staff",
                 addUserP: "Staff member who can login (Admin/User)",
                 initialPassword: "Initial Password *",
                 initialPasswordP: "User can change this upon first login.",
                 thRole: "Role *",
                 roleUser: "Warehouse User",
                 roleAdmin: "Admin",
                 submitCreateUser: "Create",
                 changePasswordTitle: "Change Password",
                 oldPassword: "Old Password",
                 newPassword: "New Password",
                 confirmNewPassword: "Confirm New Password",
                 viewEquipmentTitle: "User Equipment",
                 noEquipmentFound: "No equipment found for this user.",
                 close: "Close",
                 viewInventory: "View Inventory",
                 totalItems: "Count",
                 editEquipmentTitle: "Edit Equipment",
                 returnToWarehouse: "Return to Warehouse",
                 confirmReturn: "Return this equipment to Warehouse?",
                 formNamePlaceholder: "e.g. Dell Latitude Laptop",
                 formModelPlaceholder: "e.g. Dell Latitude 5420",
                 formSerialPlaceholder: "e.g. SN123456789",
                 formMacPlaceholder: "e.g. 00:1A:2B:3C:4D:5E",
                 btnMakeUser: "Role: Make User",
                 btnMakeAdmin: "Role: Make Admin",
                 btnDeactivate: "Lock Access",
                 btnActivate: "Unlock",
                 statusActive: "ACTIVE",
                 statusDeactivated: "LOCKED",
                 confirmChangeRole: "Are you sure you want to change this user's role?",
                 confirmDeactivate: "Do you want to BLOCK this user's access?",
                 confirmActivate: "Unlock this user?",
                 userLocked: "User deactivated.",
                 userUnlocked: "User activated.",
                 profileUpdateSuccess: "Profile updated!",
                 profileUpdateError: "Error: ",
                 errorOnSelf: "You cannot block yourself!",
                 equipmentAddedSuccess: "Equipment added successfully!",
                 errorAddingEquipment: "Error occurred!",
                 userCreateSuccess: "User created!",
                 userCreateError: "Error: ",
                 confirmDeleteEquipment: "Are you sure you want to delete this?",
            },
            ru: {
                 appName: "TechCore Инвентарь",
                 adminPanelTitle: "Панель Администратора",
                 adminWelcome: "Администратор",
                 logout: "Выход",
                 statTotalEquipment: "Всего",
                 statWorking: "Рабочие",
                 statHolders: "Владельцы",
                 statWarehouse: "На складе",
                 adminTabAllInventory: "Список инвентаря",
                 tabHolders: "Пользователи (Владельцы)",
                 adminTabUsers: "Персонал системы",
                 tabAddEquipment: "Добавить оборудование",
                 lblHolderTitle: "Данные владельца",
                 lblHolderName: "ФИО Владельца *",
                 lblHolderFaculty: "Факультет *",
                 lblSystemID: "Системный ID",
                 formType: "Тип оборудования *",
                 formTypeSelect: "Выберите тип",
                 formTypeComputer: "Компьютер",
                 formTypeMonitor: "Монитор",
                 formTypePrinter: "Принтер",
                 formTypeOther: "Другое",
                 formName: "Название *",
                 formModel: "Модель *",
                 formStatus: "Статус *",
                 formStatusWorking: "Рабочий",
                 formStatusBroken: "Сломан",
                 formStatusRepair: "В ремонте",
                 formSerial: "Серийный номер",
                 formMac: "MAC адрес",
                 formDate: "Дата покупки",
                 formUpload: "Загрузить фото",
                 formNotes: "Заметки",
                 formNotesPlaceholder: "Дополнительная информация...",
                 submitAssignEquipment: "Сохранить",
                 addUser: "Создать персонал",
                 okBtn: "ОК",
                 viewImage: "Посмотреть фото",
                 searchPlaceholder: "Поиск...",
                 emptyStateAllEquipment: "Оборудование не найдено.",
                 thNameModel: "Название / Модель",
                 thStatus: "Статус",
                 thSerial: "Серийный №",
                 thOperations: "Действия",
                 equipmentDetails: "Детали оборудования",
                 cancel: "Отмена",
                 viewEquipmentTitle: "Оборудование пользователя",
                 noEquipmentFound: "Оборудование не найдено",
                 close: "Закрыть",
                 searchHoldersPlaceholder: "Поиск владельца...",
                 searchUsersPlaceholder: "Поиск персонала...",
                 fullNameLabel: "Полное имя",
                 emailLabel: "Email адрес",
                 changePassword: "Сменить пароль",
                 updateProfile: "Обновить профиль",
                 addUserTitle: "Создать персонал",
                 addUserP: "Сотрудник с доступом (Админ/Кладовщик)",
                 initialPassword: "Начальный пароль *",
                 initialPasswordP: "Пользователь сменит при входе.",
                 thRole: "Роль *",
                 roleUser: "Кладовщик",
                 roleAdmin: "Админ",
                 submitCreateUser: "Создать",
                 changePasswordTitle: "Сменить пароль",
                 oldPassword: "Старый пароль",
                 newPassword: "Новый пароль",
                 confirmNewPassword: "Подтвердите пароль",
                 viewInventory: "Смотреть инвентарь",
                 totalItems: "Кол-во",
                 editEquipmentTitle: "Редактировать оборудование",
                 returnToWarehouse: "Вернуть на склад",
                 confirmReturn: "Вернуть это оборудование на склад?",
                 formNamePlaceholder: "напр: Dell Latitude",
                 formModelPlaceholder: "напр: Dell Latitude 5420",
                 formSerialPlaceholder: "напр: SN123456789",
                 formMacPlaceholder: "напр: 00:1A:2B:3C:4D:5E",
                 btnMakeUser: "Сделать обычным",
                 btnMakeAdmin: "Сделать админом",
                 btnDeactivate: "Блокировать",
                 btnActivate: "Разблокировать",
                 statusActive: "АКТИВЕН",
                 statusDeactivated: "БЛОК",
                 confirmChangeRole: "Сменить роль пользователя?",
                 confirmDeactivate: "Блокировать доступ?",
                 confirmActivate: "Разблокировать доступ?",
                 userLocked: "Пользователь заблокирован.",
                 userUnlocked: "Пользователь разблокирован.",
                 profileUpdateSuccess: "Профиль обновлен!",
                 profileUpdateError: "Ошибка: ",
                 errorOnSelf: "Нельзя блокировать себя!",
                 equipmentAddedSuccess: "Оборудование добавлено!",
                 errorAddingEquipment: "Ошибка!",
                 userCreateSuccess: "Пользователь создан!",
                 userCreateError: "Ошибка: ",
                 confirmDeleteEquipment: "Удалить это оборудование?",
            }
        };

        let currentLang = localStorage.getItem('appLang') || 'az';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang); 
            
            const elements = document.querySelectorAll('[data-key]');
            
            elements.forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang][key]) {
                    if ((el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') && el.getAttribute('placeholder')) {
                        el.placeholder = ""; 
                        // Modified logic to include edit notes
                        if(el.id.includes('search') || el.id.includes('notes')) {
                            el.placeholder = translations[lang][key];
                        }
                    } else {
                        // Check if it's a dropdown option (don't add icon)
                        if (el.tagName === 'OPTION') {
                             el.textContent = translations[lang][key];
                        } else if(el.children.length > 0 && el.querySelector('i')) {
                             const icon = el.querySelector('i').outerHTML;
                             el.innerHTML = icon + ' ' + translations[lang][key];
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                }
            });

            const langBtnText = document.querySelector('.lang-btn-text');
            if(langBtnText) langBtnText.textContent = lang.toUpperCase();
            
            const dropdown = document.getElementById('lang-dropdown');
            if(dropdown) dropdown.classList.remove('show');
            
            // Re-render dynamic lists to update translated values
            renderUserCards(allUsersCache);
            if (typeof filterAndRenderInventory === 'function') filterAndRenderInventory();
            renderHoldersList();
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // === MAPS FOR TRANSLATING VALUES FROM DB ===
        const typeMap = {
            "Kompüter": "formTypeComputer",
            "Monitor": "formTypeMonitor",
            "Printer": "formTypePrinter",
            "Digər": "formTypeOther",
            "Computer": "formTypeComputer",
            "Компьютер": "formTypeComputer"
        };

        const statusMap = {
            "İşlək": "formStatusWorking",
            "Xarab": "formStatusBroken",
            "Təmirdə": "formStatusRepair",
            "Working": "formStatusWorking",
            "Broken": "formStatusBroken",
            "Repair": "formStatusRepair"
        };

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyAI2rM3vttKrDI9C4vDD41_hcXurLvQ6gw",
            authDomain: "it-inventory-tracker-61d2c.firebaseapp.com",
            projectId: "it-inventory-tracker-61d2c",
            storageBucket: "it-inventory-tracker-61d2c.firebasestorage.app",
            messagingSenderId: "557225811726",
            appId: "1:557225811726:web:f85c3ca033997d2f95c15f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const secondaryApp = firebase.initializeApp(firebaseConfig, "secondary");
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let currentAdminUID = null;
        let allUsersCache = []; 
        let allEquipmentCache = []; 
        let uniqueHoldersMap = {}; 

        // --- AUTH YOXLAMASI ---
        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection("users").doc(user.uid).onSnapshot(doc => {
                    if (doc.exists && doc.data().role === 'admin') {
                        if(doc.data().status === 'deactivated') {
                            alert("Hesabınız deaktiv edilib!");
                            auth.signOut();
                            return;
                        }

                        currentAdminUID = user.uid; 
                        const userData = doc.data();
                        const name = userData.name || t('adminWelcome');
                        const profilePicUrl = userData.profilePicUrl;

                        const adminNameDisplay = document.getElementById('admin-name-display');
                        adminNameDisplay.innerText = name;
                        adminNameDisplay.removeAttribute('data-key');
                        
                        document.getElementById('profile-name').value = name;
                        document.getElementById('profile-email').value = user.email;

                        const initials = name.split(' ').map(n => n[0]).join('').substring(0,2);
                        const headerPic = document.getElementById('profile-pic-header');
                        const modalPic = document.getElementById('profile-pic-modal');
                        
                        if (profilePicUrl) {
                            headerPic.style.backgroundImage = `url(${profilePicUrl})`;
                            headerPic.innerText = '';
                            modalPic.style.backgroundImage = `url(${profilePicUrl})`;
                            modalPic.innerText = '';
                        } else {
                            headerPic.style.backgroundImage = '';
                            headerPic.innerText = initials;
                            modalPic.style.backgroundImage = '';
                            modalPic.innerText = initials;
                        }
                        
                        loadAdminData(); 
                        setLanguage(currentLang); 
                        generateTechCoreID();
                        checkUrlForQR(); 
                        
                    } else {
                        window.location.href = "dashboard.html";
                    }
                }, err => {
                        window.location.href = "index.html";
                });
            } else {
                window.location.href = "index.html";
            }
        });

        function generateTechCoreID() {
            const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
            const newID = `TC-${randomPart}`;
            const idField = document.getElementById('auto-id');
            if(idField) idField.value = newID;
            
            const dateField = document.getElementById('admin-equip-date');
            if(dateField) {
                dateField.valueAsDate = new Date();
            }
        }

        // --- ÜMUMİ FUNKSİYALAR ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => { window.location.href = "index.html"; });
        });

        const tabLinks = document.querySelectorAll('.tab-nav .tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = link.getAttribute('data-tab');
                tabLinks.forEach(item => item.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        function updateStatCards(equipmentList) {
            let total = equipmentList.length;
            let islek = equipmentList.filter(e => e.status === 'İşlək').length;
            const uniqueHolders = new Set(equipmentList.map(e => e.holderName).filter(Boolean));
            let holderCount = uniqueHolders.size;
            
            let anbarCount = equipmentList.filter(e => e.holderName === 'Anbar').length;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-islek').innerText = islek;
            document.getElementById('stat-holders').innerText = holderCount;
            document.getElementById('stat-anbar').innerText = anbarCount;
        }

        function updateHoldersData() {
            uniqueHoldersMap = {}; 
            allEquipmentCache.forEach(equip => {
                const name = equip.holderName;
                if(name) {
                    if (!uniqueHoldersMap[name]) {
                        uniqueHoldersMap[name] = {
                            faculty: equip.holderFaculty,
                            count: 0
                        };
                    }
                    uniqueHoldersMap[name].count++;
                }
            });

            const dataList = document.getElementById('holder-suggestions');
            dataList.innerHTML = '';
            Object.keys(uniqueHoldersMap).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                dataList.appendChild(option);
            });

            renderHoldersList();
        }
        
        function renderHoldersList() {
            const container = document.getElementById('all-holders-list');
            const emptyState = document.getElementById('holders-empty-state');
            const searchTerm = document.getElementById('holders-search').value.toLowerCase();

            container.innerHTML = '';
            let hasItems = false;

            const sortedNames = Object.keys(uniqueHoldersMap).sort((a, b) => {
                if (a === 'Anbar') return -1;
                if (b === 'Anbar') return 1;
                return a.localeCompare(b);
            });

            sortedNames.forEach(name => {
                const data = uniqueHoldersMap[name];
                const searchString = (name + ' ' + data.faculty).toLowerCase();

                if (searchString.includes(searchTerm)) {
                    hasItems = true;
                    const initials = name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();

                    const card = `
                    <div class="holder-card" data-name="${name}">
                        <div class="holder-header">
                            <div class="holder-icon">${initials}</div>
                            <div class="holder-details">
                                <h3>${name}</h3>
                                <p>${data.faculty}</p>
                            </div>
                        </div>
                        <div class="holder-stats">
                            <span>${t('totalItems')}:</span>
                            <span class="holder-count">${data.count}</span>
                        </div>
                        <div class="holder-actions">
                            <button onclick="openHolderInventory('${name}')"><i class="fas fa-list"></i> ${t('viewInventory')}</button>
                        </div>
                    </div>
                    `;
                    container.innerHTML += card;
                }
            });

            if (!hasItems) emptyState.style.display = 'block';
            else emptyState.style.display = 'none';
        }

        document.getElementById('holders-search').addEventListener('input', renderHoldersList);

        document.getElementById('holder-name').addEventListener('input', function() {
            const enteredName = this.value;
            if (uniqueHoldersMap[enteredName]) {
                const fac = uniqueHoldersMap[enteredName].faculty;
                const select = document.getElementById('holder-faculty');
                const otherInput = document.getElementById('other-faculty-input');
                
                let found = false;
                for(let i=0; i<select.options.length; i++){
                    if(select.options[i].value === fac){
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                
                if(found) {
                      otherInput.style.display = 'none';
                } else {
                    select.value = 'Digər';
                    otherInput.style.display = 'block';
                    otherInput.value = fac;
                }
            }
        });

        document.getElementById('holder-faculty').addEventListener('change', function() {
            const otherInput = document.getElementById('other-faculty-input');
            if(this.value === 'Digər') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
            }
        });

        document.getElementById('edit-holder-faculty').addEventListener('change', function() {
            const otherInput = document.getElementById('edit-other-faculty-input');
            if(this.value === 'Digər') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
            }
        });

        function filterAndRenderInventory() {
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            let filteredList;

            if (!searchTerm) {
                filteredList = allEquipmentCache;
            } else {
                filteredList = allEquipmentCache.filter(equip => {
                    const statusText = t(statusMap[equip.status] || equip.status).toLowerCase();
                    const typeText = t(typeMap[equip.type] || equip.type).toLowerCase();
                    
                    const searchData = [
                        equip.name, equip.model, equip.serial, equip.mac, equip.type, equip.status, 
                        equip.holderName, equip.holderFaculty, equip.systemId,
                        statusText, typeText
                    ].join(' ').toLowerCase();
                    return searchData.includes(searchTerm);
                });
            }
            
            renderEquipmentCards(filteredList);
            updateStatCards(filteredList);
        }

        function loadAdminData() {
            db.collection("equipment").onSnapshot(snapshot => {
                allEquipmentCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateHoldersData(); 
                filterAndRenderInventory(); 
                checkUrlForQR();
            });
            db.collection("users").onSnapshot(snapshot => {
                allUsersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserCards(allUsersCache); 
            });
        }
        
        function checkUrlForQR() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewId = urlParams.get('viewId');
            if (viewId && allEquipmentCache.length > 0) {
                viewItemDetails(viewId);
            }
        }

        function renderEquipmentCards(equipmentList) {
            const container = document.getElementById('all-equipment-list');
            const emptyState = document.getElementById('all-empty-state');
            container.innerHTML = "";
            
            if (equipmentList.length === 0) emptyState.style.display = "block";
            else emptyState.style.display = "none";
            
            equipmentList.forEach(equip => {
                const holderInfo = equip.holderName ? `${equip.holderName} (${equip.holderFaculty})` : "Təyin edilməyib";
                const searchData = [equip.name, equip.model, equip.serial, equip.mac, equip.type, equip.status, equip.holderName].join(' ').toLowerCase();
                
                const translatedStatus = t(statusMap[equip.status] || equip.status);
                const translatedType = t(typeMap[equip.type] || equip.type);

                const card = `
                <div class="equipment-card visible" data-search="${searchData}">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">${equip.name}</h3>
                            <p class="card-subtitle">${equip.model}</p>
                            <div class="card-tags">
                                <span class="tag user-tag" style="background:#e3f2fd; color:#0984e3;"><i class="fas fa-user"></i> ${holderInfo}</span>
                                <span class="tag status-${equip.status.toLowerCase()}">${translatedStatus}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div>${t('formSerial')}: <span>${equip.serial || '-'}</span></div>
                        <div>${t('formMac')}: <span>${equip.mac || '-'}</span></div>
                        <div>${t('formType')}: <span>${translatedType}</span></div>
                    </div>
                    <div class="card-footer">
                        <span><i class="fas fa-calendar-alt"></i> ${new Date(equip.addedAt.seconds * 1000).toLocaleDateString()}</span>
                        <div style="display:flex;">
                            <button class="action-btn btn-qr" onclick="openQRModal('${equip.id}')" title="QR Kod"><i class="fas fa-qrcode"></i></button>
                            <button class="action-btn btn-view" onclick="viewItemDetails('${equip.id}')" title="Ətraflı"><i class="fas fa-eye"></i></button>
                            <button class="action-btn btn-edit" onclick="openEditModal('${equip.id}')" title="Redaktə/Transfer"><i class="fas fa-pen"></i></button>
                            <button class="action-btn btn-return" onclick="returnToWarehouse('${equip.id}')" title="Anbara Qaytar"><i class="fas fa-box-open"></i></button>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += card;
            });
        }
        
        window.deleteEquipment = function(id) {
            if(confirm(t('confirmDeleteEquipment'))) {
                db.collection("equipment").doc(id).delete().catch(err => alert("Error: " + err.message));
            }
        }
        
        window.openHolderInventory = function(holderName) {
             const viewEquipmentModal = document.getElementById('view-equipment-modal');
             
             // Update dynamic part manually, key part handles itself
             document.getElementById('view-equip-holder-name').innerText = holderName;
             
             const tableBody = document.getElementById('user-specific-equipment-tbody');
             const emptyState = document.getElementById('user-specific-empty-state');
             tableBody.innerHTML = '';
             emptyState.style.display = 'none';
             viewEquipmentModal.style.display = 'flex';

             const specificItems = allEquipmentCache.filter(item => item.holderName === holderName);

             if (specificItems.length === 0) {
                 emptyState.style.display = 'block';
             } else {
                 specificItems.forEach(equip => {
                     const translatedStatus = t(statusMap[equip.status] || equip.status);
                     const row = `
                        <tr>
                            <td>${equip.name} (${equip.model})</td>
                            <td class="status-${equip.status.toLowerCase()}">${translatedStatus}</td>
                            <td>${equip.serial || '-'}</td>
                            <td style="display:flex; gap:5px; justify-content:center;">
                                <button class="action-btn btn-qr" onclick="openQRModal('${equip.id}')" title="QR Kod"><i class="fas fa-qrcode"></i></button>
                                <button class="action-btn btn-view" onclick="viewItemDetails('${equip.id}')" title="Ətraflı"><i class="fas fa-eye"></i></button>
                                <button class="action-btn btn-edit" onclick="openEditModal('${equip.id}')" title="Redaktə/Transfer"><i class="fas fa-pen"></i></button>
                                <button class="action-btn btn-return" onclick="returnToWarehouse('${equip.id}')" title="Anbara Qaytar"><i class="fas fa-box-open"></i></button>
                            </td>
                        </tr>
                      `;
                      tableBody.innerHTML += row;
                 });
             }
        }

        window.openQRModal = function(id) {
            if (window.event) window.event.stopPropagation();
            const item = allEquipmentCache.find(e => e.id === id);
            if(!item) return;

            document.getElementById('qr-modal').style.display = 'flex';
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ""; 
            
            const currentUrl = window.location.href.split('?')[0]; 
            const qrUrl = `${currentUrl}?viewId=${item.id}`;
            
            document.getElementById('qr-link-text').innerText = qrUrl;
            
            new QRCode(qrContainer, {
                text: qrUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
        
        window.downloadQR = function() {
            const qrContainer = document.getElementById('qrcode');
            const img = qrContainer.querySelector('img');
            
            if(img && img.src) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = 'QR_Code.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("QR kod hələ yaranmayıb, bir az gözləyin.");
            }
        }

        window.viewItemDetails = function(id) {
            const item = allEquipmentCache.find(e => e.id === id);
            if(!item) return;

            const content = document.getElementById('item-details-content');
            const statusText = t(statusMap[item.status] || item.status);
            const typeText = t(typeMap[item.type] || item.type);
            
            content.innerHTML = `
                <div class="detail-item full-width"><span class="detail-label" style="color: #0984e3;">SYSTEM ID</span><span class="detail-value" style="font-weight: bold; font-size: 16px;">${item.systemId || 'N/A'}</span></div>
                <div class="detail-item full-width"><span class="detail-label">${t('lblHolderName')}</span><span class="detail-value">${item.holderName}</span></div>
                <div class="detail-item full-width"><span class="detail-label">${t('lblHolderFaculty')}</span><span class="detail-value">${item.holderFaculty}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formName')}</span><span class="detail-value">${item.name}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formModel')}</span><span class="detail-value">${item.model}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formType')}</span><span class="detail-value">${typeText}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formStatus')}</span><span class="detail-value">${statusText}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formSerial')}</span><span class="detail-value">${item.serial || '-'}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formMac')}</span><span class="detail-value">${item.mac || '-'}</span></div>
                <div class="detail-item"><span class="detail-label">${t('formDate')}</span><span class="detail-value">${item.purchaseDate || '-'}</span></div>
                <div class="detail-item full-width"><span class="detail-label">${t('formNotes')}</span><span class="detail-value">${item.notes || '-'}</span></div>
            `;
            
            const imageContainer = document.getElementById('item-image-container');
            if (item.imageUrl) {
                imageContainer.innerHTML = `<button class="btn-view-image" onclick="window.open('${item.imageUrl}', '_blank')"><i class="fas fa-image"></i> ${t('viewImage')}</button>`;
            } else {
                imageContainer.innerHTML = "";
            }
            
            document.getElementById('item-details-modal').style.display = 'flex';
        }

        const editModal = document.getElementById('edit-equipment-modal');
        
        window.openEditModal = function(id) {
            const item = allEquipmentCache.find(e => e.id === id);
            if(!item) return;
            
            document.getElementById('edit-equip-id').value = id;
            document.getElementById('edit-holder-name').value = item.holderName;
            
            const select = document.getElementById('edit-holder-faculty');
            const otherInput = document.getElementById('edit-other-faculty-input');
            
            let found = false;
            for(let i=0; i<select.options.length; i++){
                if(select.options[i].value === item.holderFaculty){
                    select.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            if(found) {
                 otherInput.style.display = 'none';
                 otherInput.value = '';
            } else {
                select.value = 'Digər';
                otherInput.style.display = 'block';
                otherInput.value = item.holderFaculty;
            }

            document.getElementById('edit-equip-name').value = item.name;
            document.getElementById('edit-equip-model').value = item.model;
            document.getElementById('edit-equip-serial').value = item.serial || '';
            document.getElementById('edit-equip-mac').value = item.mac || '';
            document.getElementById('edit-equip-type').value = item.type;
            document.getElementById('edit-equip-status').value = item.status;
            document.getElementById('edit-equip-notes').value = item.notes || '';
            
            // Set current placeholder text based on language
            const noteArea = document.getElementById('edit-equip-notes');
            noteArea.placeholder = t('formNotesPlaceholder');

            document.getElementById('btn-return-warehouse').setAttribute('data-id', id);
            
            editModal.style.display = 'flex';
        }

        document.getElementById('edit-equipment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-equip-id').value;
            
            let fac = document.getElementById('edit-holder-faculty').value;
            if (fac === 'Digər') {
                fac = document.getElementById('edit-other-faculty-input').value;
            }

            const updates = {
                holderName: document.getElementById('edit-holder-name').value,
                holderFaculty: fac,
                name: document.getElementById('edit-equip-name').value,
                model: document.getElementById('edit-equip-model').value,
                serial: document.getElementById('edit-equip-serial').value,
                mac: document.getElementById('edit-equip-mac').value,
                type: document.getElementById('edit-equip-type').value,
                status: document.getElementById('edit-equip-status').value,
                notes: document.getElementById('edit-equip-notes').value
            };
            
            db.collection("equipment").doc(id).update(updates).then(() => {
                alert("Məlumat yeniləndi!");
                editModal.style.display = 'none';
                document.getElementById('view-equipment-modal').style.display = 'none'; 
            });
        });

        document.getElementById('btn-return-warehouse').addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            returnToWarehouse(id);
        });

        window.returnToWarehouse = function(id) {
            if(confirm(t('confirmReturn'))) {
                db.collection("equipment").doc(id).update({
                    holderName: "Anbar",
                    holderFaculty: "Anbar"
                }).then(() => {
                    alert("Avadanlıq Anbara qaytarıldı!");
                    editModal.style.display = 'none';
                    document.getElementById('view-equipment-modal').style.display = 'none';
                });
            }
        }

        document.getElementById('edit-equipment-close').onclick = () => editModal.style.display = 'none';
        document.getElementById('edit-equipment-cancel').onclick = () => editModal.style.display = 'none';
        
        document.getElementById('item-details-close').onclick = () => {
             document.getElementById('item-details-modal').style.display = 'none';
             history.pushState({}, document.title, window.location.pathname);
        }
        document.getElementById('item-details-ok').onclick = () => {
            document.getElementById('item-details-modal').style.display = 'none';
            history.pushState({}, document.title, window.location.pathname);
        }

        document.getElementById('view-equipment-close-btn').onclick = () => document.getElementById('view-equipment-modal').style.display = 'none';
        document.getElementById('view-equipment-close-footer-btn').onclick = () => document.getElementById('view-equipment-modal').style.display = 'none';

        function renderUserCards(userList) {
            const container = document.getElementById('all-users-list');
            container.innerHTML = "";
            
            userList.forEach(user => {
                const isAdmin = user.role === 'admin';
                const isDeactivated = user.status === 'deactivated';
                const initials = (user.name || 'User').split(' ').map(n => n[0]).join('').substring(0,2);
                
                const roleText = isAdmin ? t('roleAdmin') : t('roleUser');
                const buttonRoleText = isAdmin ? t('btnMakeUser') : t('btnMakeAdmin');
                const lockBtnText = isDeactivated ? t('btnActivate') : t('btnDeactivate');
                const lockBtnIcon = isDeactivated ? 'fa-lock-open' : 'fa-lock';
                const lockBtnClass = isDeactivated ? 'btn-approve' : 'btn-reject'; 
                const statusBadge = isDeactivated ? `<span class="status-badge badge-deactive">${t('statusDeactivated')}</span>` : `<span class="status-badge badge-active">${t('statusActive')}</span>`;
                const roleBadgeClass = isAdmin ? 'role-badge' : 'role-badge warehouse';

                const card = `
                <div class="user-card visible ${isDeactivated ? 'deactivated' : ''}" data-search="${(user.name || '').toLowerCase()} ${(user.email || '').toLowerCase()} ${(user.role || '').toLowerCase()}">
                    <div class="user-card-top">
                        <div class="user-info">
                            <div class="user-avatar ${isAdmin ? 'admin' : ''}" style="background-image: url(${user.profilePicUrl || ''})">${user.profilePicUrl ? '' : initials}</div>
                            <div class="user-details">
                                <span class="user-name">${user.name}</span>
                                <span class="user-email">${user.email}</span>
                            </div>
                        </div>
                        <div class="card-tags">
                             <span class="tag ${roleBadgeClass}">${roleText}</span>
                             ${statusBadge}
                        </div>
                    </div>

                    <div class="user-actions">
                        <button class="user-action-btn role-toggle-btn ${isAdmin ? 'role-admin' : 'role-user'}" data-id="${user.id}" data-role="${user.role}">
                            <i class="fas fa-user-shield"></i> ${buttonRoleText}
                        </button>
                        <button class="user-action-btn ${lockBtnClass} status-toggle-btn" data-id="${user.id}" data-status="${user.status || 'active'}">
                            <i class="fas ${lockBtnIcon}"></i> ${lockBtnText}
                        </button>
                    </div>
                </div>
                `;
                container.innerHTML += card;
            });
        }
        
        document.getElementById('inventory-search').addEventListener('input', filterAndRenderInventory);
        document.getElementById('user-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.user-card').forEach(card => {
                const searchData = card.getAttribute('data-search');
                if (searchData.includes(searchTerm)) card.classList.add('visible');
                else card.classList.remove('visible');
            });
        });
        
        document.getElementById('all-users-list').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.classList.contains('role-toggle-btn')) {
                const docId = button.getAttribute('data-id'); 
                if (!docId) return;
                if (docId === currentAdminUID) { alert(t('errorOnSelf')); return; }
                
                const oldRole = button.getAttribute('data-role');
                const newRole = oldRole === 'admin' ? 'user' : 'admin';
                if (confirm(t('confirmChangeRole'))) {
                    db.collection("users").doc(docId).update({ role: newRole });
                }
            }

            if (button.classList.contains('status-toggle-btn')) {
                const docId = button.getAttribute('data-id');
                const currentStatus = button.getAttribute('data-status');
                
                if (docId === currentAdminUID) { alert(t('errorOnSelf')); return; }

                const newStatus = (currentStatus === 'deactivated') ? 'active' : 'deactivated';
                const confirmMsg = (newStatus === 'deactivated') ? t('confirmDeactivate') : t('confirmActivate');

                if (confirm(confirmMsg)) {
                    db.collection("users").doc(docId).update({ status: newStatus })
                        .then(() => {
                            const msg = (newStatus === 'deactivated') ? t('userLocked') : t('userUnlocked');
                            alert(msg);
                        })
                        .catch(err => alert("Xəta: " + err.message));
                }
            }
        });
        
        const profileModal = document.getElementById('profile-modal');
        document.getElementById('profile-btn').onclick = () => profileModal.style.display = 'flex';
        document.getElementById('profile-modal-close').onclick = () => profileModal.style.display = 'none';
        document.getElementById('profile-cancel-btn').onclick = () => profileModal.style.display = 'none';

        document.getElementById('profile-settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('profile-name').value;
            db.collection("users").doc(currentAdminUID).update({ name: name })
            .then(() => { alert(t('profileUpdateSuccess')); profileModal.style.display = 'none'; })
            .catch(err => { alert(t('profileUpdateError') + err.message); });
        });
        
        document.getElementById('profile-pic-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const storageRef = storage.ref(`profile_pics/${currentAdminUID}/${file.name}`);
            const uploadTask = storageRef.put(file);
            uploadTask.on('state_changed', 
                (snapshot) => {}, 
                (error) => { alert(t('profileUpdateError') + error.message); }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.collection("users").doc(currentAdminUID).update({ profilePicUrl: downloadURL });
                    });
                }
            );
        });
        
        const changePasswordModal = document.getElementById('change-password-modal');
        document.getElementById('change-password-btn-open').addEventListener('click', () => {
            profileModal.style.display = 'none';
            changePasswordModal.style.display = 'flex';
        });
        document.getElementById('password-modal-close').onclick = () => changePasswordModal.style.display = 'none';
        document.getElementById('password-cancel-btn').onclick = () => changePasswordModal.style.display = 'none';
        
        const addUserModal = document.getElementById('add-user-modal');
        document.getElementById('add-user-btn').onclick = () => addUserModal.style.display = 'flex';
        document.getElementById('add-user-modal-close').onclick = () => addUserModal.style.display = 'none';
        document.getElementById('add-user-cancel-btn').onclick = () => addUserModal.style.display = 'none';
        
        document.getElementById('add-user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;
            
            secondaryApp.auth().createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const uid = userCredential.user.uid;
                    db.collection("users").doc(uid).set({ name: name, email: email, role: role, status: 'active' })
                    .then(() => {
                        alert(t('userCreateSuccess'));
                        addUserModal.style.display = 'none';
                        document.getElementById('add-user-form').reset();
                        secondaryApp.auth().signOut(); 
                    });
                })
                .catch(error => { alert(t('userCreateError') + error.message); });
        });
        
        // --- AVADANLIQ ƏLAVƏ ETMƏ ---
        document.getElementById('admin-add-equipment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const adminAddForm = document.getElementById('admin-add-equipment-form');
            
            const holderName = document.getElementById('holder-name').value;
            
            let holderFaculty = document.getElementById('holder-faculty').value;
            if (holderFaculty === 'Digər') {
                holderFaculty = document.getElementById('other-faculty-input').value;
            }

            const systemId = document.getElementById('auto-id').value; 
            const fileInput = document.getElementById('admin-equip-file');
            const file = fileInput.files[0];

            // Şəkil Yükləmə Funksiyası
            const uploadImage = async () => {
                if (!file) return null;
                const storageRef = storage.ref(`equipment_images/${Date.now()}_${file.name}`);
                await storageRef.put(file);
                return await storageRef.getDownloadURL();
            };

            uploadImage().then(imageUrl => {
                const equipmentData = {
                    type: adminAddForm.querySelector('#admin-equip-type').value,
                    name: adminAddForm.querySelector('#admin-equip-name').value,
                    model: adminAddForm.querySelector('#admin-equip-model').value,
                    serial: adminAddForm.querySelector('#admin-equip-serial').value,
                    mac: adminAddForm.querySelector('#admin-equip-mac').value,
                    status: adminAddForm.querySelector('#admin-equip-status').value,
                    notes: adminAddForm.querySelector('#admin-equip-notes').value, 
                    purchaseDate: adminAddForm.querySelector('#admin-equip-date').value, 
                    addedAt: new Date(),
                    holderName: holderName,
                    holderFaculty: holderFaculty,
                    addedByAdminId: currentAdminUID, 
                    approvalStatus: "approved",
                    systemId: systemId,
                    imageUrl: imageUrl 
                };

                db.collection("equipment").add(equipmentData)
                    .then(() => {
                        alert(t('equipmentAddedSuccess'));
                        adminAddForm.reset(); 
                        
                        document.getElementById('holder-faculty').value = "";
                        document.getElementById('other-faculty-input').style.display = 'none';
                        
                        generateTechCoreID(); 
                        document.querySelector('.tab-link[data-tab="inventory-tab"]').click();
                    })
                    .catch((error) => { alert(t('errorAddingEquipment') + ": " + error.message); });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const langBtn = document.getElementById('lang-btn');
            const dropdown = document.getElementById('lang-dropdown');
            
            if(langBtn && dropdown) {
                langBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('show');
                });
                window.addEventListener('click', () => {
                    if (dropdown.classList.contains('show')) dropdown.classList.remove('show');
                });
            }
            document.querySelectorAll('.lang-dropdown a').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    setLanguage(e.target.getAttribute('data-lang'));
                });
            });
            setLanguage(currentLang);
        });

    </script>
</body>
</html>